{
  "filename": "springcloud.md",
  "__html": "<h1>SpringCloud示例</h1>\n<p>SpringCloud 示例说明<br>\n共三个模块如下：<br>\nSpringServiceA (发起方 | LCN模式)<br>\nSpringServiceB (参与方 | TXC模式)<br>\nSpringServiceC (参与方 | TCC模式)</p>\n<p>代码地址:<a href=\"https://github.com/codingapi/txlcn-demo\">https://github.com/codingapi/txlcn-demo</a></p>\n<h2>一、调用关系说明:</h2>\n<ol>\n<li>SpringServiceA -&gt; DemoController的<code>txlcn</code>的Mapping是调用发起方法，代码如下。</li>\n</ol>\n<pre><code class=\"language-java\"><span class=\"hljs-meta\">@RestController</span>\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">DemoController</span> </span>{\n\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">final</span> DemoService demoService;\n\n    <span class=\"hljs-meta\">@Autowired</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">DemoController</span><span class=\"hljs-params\">(DemoService demoService)</span> </span>{\n        <span class=\"hljs-keyword\">this</span>.demoService = demoService;\n    }\n\n    <span class=\"hljs-meta\">@RequestMapping</span>(<span class=\"hljs-string\">\"/txlcn\"</span>)\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">execute</span><span class=\"hljs-params\">(\n            @RequestParam(<span class=\"hljs-string\">\"value\"</span>)</span> String value,\n            @<span class=\"hljs-title\">RequestParam</span><span class=\"hljs-params\">(value = <span class=\"hljs-string\">\"ex\"</span>, required = <span class=\"hljs-keyword\">false</span>)</span> String exFlag) </span>{\n        <span class=\"hljs-keyword\">return</span> demoService.execute(value, exFlag);\n    }\n}\n\n</code></pre>\n<ol start=\"2\">\n<li>demoService.execute(value, exFlag)代码:</li>\n</ol>\n<pre><code class=\"language-java\">\n<span class=\"hljs-meta\">@Service</span>\n<span class=\"hljs-meta\">@Slf</span>4j\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">DemoServiceImpl</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">DemoService</span> </span>{\n\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">final</span> DemoMapper demoMapper;\n\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">final</span> ServiceBClient serviceBClient;\n\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">final</span> ServiceCClient serviceCClient;\n\n    <span class=\"hljs-meta\">@Autowired</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">DemoServiceImpl</span><span class=\"hljs-params\">(\n            ClientDemoMapper demoMapper,\n            ServiceBClient serviceBClient,\n            ServiceCClient serviceCClient)</span> </span>{\n        <span class=\"hljs-keyword\">this</span>.demoMapper = demoMapper;\n        <span class=\"hljs-keyword\">this</span>.serviceBClient = serviceBClient;\n        <span class=\"hljs-keyword\">this</span>.serviceCClient = serviceCClient;\n    }\n\n    <span class=\"hljs-meta\">@Override</span>\n    <span class=\"hljs-meta\">@LcnTransaction</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">execute</span><span class=\"hljs-params\">(String value)</span> </span>{\n\n        <span class=\"hljs-comment\">// ServiceB</span>\n        String dResp = serviceBClient.rpc(value);\n\n        <span class=\"hljs-comment\">// ServiceC</span>\n        String eResp = serviceCClient.rpc(value);\n\n        <span class=\"hljs-comment\">// Local transaction</span>\n        Demo demo = <span class=\"hljs-keyword\">new</span> Demo();\n        demo.setGroupId(DTXLocalContext.getOrNew().getGroupId());  \n        demo.setDemoField(value);\n        demo.setAppName(Transactions.APPLICATION_ID_WHEN_RUNNING);\n        demo.setCreateTime(<span class=\"hljs-keyword\">new</span> Date());\n        demoMapper.save(demo);\n\n        <span class=\"hljs-comment\">// 置异常标志，DTX 回滚</span>\n        <span class=\"hljs-keyword\">if</span> (Objects.nonNull(exFlag)) {\n            <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> IllegalStateException(<span class=\"hljs-string\">\"by exFlag\"</span>);\n        }\n        <span class=\"hljs-keyword\">return</span> dResp + <span class=\"hljs-string\">\" &gt; \"</span> + eResp + <span class=\"hljs-string\">\" &gt; \"</span> + <span class=\"hljs-string\">\"ok-service-a\"</span>;\n    }\n}\n</code></pre>\n<ol start=\"3\">\n<li>ServiceBClient.rpc(value)代码:</li>\n</ol>\n<pre><code class=\"language-java\"><span class=\"hljs-meta\">@Service</span>\n<span class=\"hljs-meta\">@Slf</span>4j\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">DemoServiceImpl</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">DemoService</span> </span>{\n\n   <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">final</span> DemoMapper demoMapper;\n\n\n   <span class=\"hljs-meta\">@Autowired</span>\n   <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">DemoServiceImpl</span><span class=\"hljs-params\">(DemoMapper demoMapper)</span> </span>{\n       <span class=\"hljs-keyword\">this</span>.demoMapper = demoMapper;\n   }\n\n   <span class=\"hljs-meta\">@Override</span>\n   <span class=\"hljs-meta\">@TxcTransaction</span>(propagation = DTXPropagation.SUPPORTS)\n   <span class=\"hljs-meta\">@Transactional</span>\n   <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">rpc</span><span class=\"hljs-params\">(String value)</span> </span>{\n       Demo demo = <span class=\"hljs-keyword\">new</span> Demo();\n       demo.setGroupId(TracingContext.tracing().groupId());\n       demo.setDemoField(value);\n       demo.setAppName(Transactions.getApplicationId());\n       demo.setCreateTime(<span class=\"hljs-keyword\">new</span> Date());\n       demoMapper.save(demo);\n       <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">\"ok-service-b\"</span>;\n   }\n}\n\n</code></pre>\n<ol start=\"4\">\n<li>ServiceCClient.rpc(value)代码：</li>\n</ol>\n<pre><code class=\"language-java\"><span class=\"hljs-meta\">@Service</span>\n<span class=\"hljs-meta\">@Slf</span>4j\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">DemoServiceImpl</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">DemoService</span> </span>{\n\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">final</span> DemoMapper demoMapper;\n\n    <span class=\"hljs-keyword\">private</span> ConcurrentHashMap&lt;String, Long&gt; ids = <span class=\"hljs-keyword\">new</span> ConcurrentHashMap&lt;&gt;();\n\n    <span class=\"hljs-meta\">@Autowired</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">DemoServiceImpl</span><span class=\"hljs-params\">(DemoMapper demoMapper)</span> </span>{\n        <span class=\"hljs-keyword\">this</span>.demoMapper = demoMapper;\n    }\n\n    <span class=\"hljs-meta\">@Override</span>\n    <span class=\"hljs-meta\">@TccTransaction</span>(propagation = DTXPropagation.SUPPORTS)\n    <span class=\"hljs-meta\">@Transactional</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">rpc</span><span class=\"hljs-params\">(String value)</span> </span>{\n        Demo demo = <span class=\"hljs-keyword\">new</span> Demo();\n        demo.setDemoField(value);\n        demo.setCreateTime(<span class=\"hljs-keyword\">new</span> Date());\n        demo.setAppName(Transactions.getApplicationId());\n        demo.setGroupId(TracingContext.tracing().groupId());\n        demoMapper.save(demo);\n        ids.put(TracingContext.tracing().groupId(), demo.getId());\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">\"ok-service-c\"</span>;\n    }\n\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">confirmRpc</span><span class=\"hljs-params\">(String value)</span> </span>{\n        log.info(<span class=\"hljs-string\">\"tcc-confirm-\"</span> + TracingContext.tracing().groupId());\n        ids.remove(TracingContext.tracing().groupId());\n    }\n\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">cancelRpc</span><span class=\"hljs-params\">(String value)</span> </span>{\n        log.info(<span class=\"hljs-string\">\"tcc-cancel-\"</span> + TracingContext.tracing().groupId());\n        Long kid = ids.get(TracingContext.tracing().groupId());\n        demoMapper.deleteByKId(kid);\n    }\n}\n\n</code></pre>\n<h2>二、工程代码概览</h2>\n<ol>\n<li>事务发起方，txlcn-demo-spring-service-a</li>\n</ol>\n<ul>\n<li>工程截图<br>\n<img src=\"../../../img/docs/tc_project_a.png\" alt=\"maven project\"></li>\n<li>项目配置文件 application.properties</li>\n</ul>\n<pre><code class=\"language-properties\"><span class=\"hljs-comment\">##################</span>\n<span class=\"hljs-comment\"># 这个是启动本服务的配置文件，其它的application-xxx.properties 是开发者的个性化配置，不用关心。</span>\n<span class=\"hljs-comment\"># 你可以在 https://txlcn.org/zh-cn/docs/setting/client.html 看到所有的个性化配置</span>\n<span class=\"hljs-comment\">#################</span>\n\n<span class=\"hljs-meta\">spring.application.name</span>=<span class=\"hljs-string\">txlcn-demo-spring-service-a</span>\n<span class=\"hljs-meta\">server.port</span>=<span class=\"hljs-string\">12011</span>\n<span class=\"hljs-meta\">spring.datasource.driver-class-name</span>=<span class=\"hljs-string\">com.mysql.jdbc.Driver</span>\n<span class=\"hljs-comment\">## TODO 你的配置</span>\n<span class=\"hljs-meta\">spring.datasource.url</span>=<span class=\"hljs-string\">jdbc:mysql://127.0.0.1:3306/txlcn-demo?\\\ncharacterEncoding=UTF-8&amp;serverTimezone=UTC</span>\n<span class=\"hljs-meta\">spring.datasource.username</span>=<span class=\"hljs-string\">root</span>\n<span class=\"hljs-meta\">spring.datasource.password</span>=<span class=\"hljs-string\">root</span>\n<span class=\"hljs-meta\">spring.datasource.hikari.maximum-pool-size</span>=<span class=\"hljs-string\">20</span>\n<span class=\"hljs-meta\">mybatis.configuration.map-underscore-to-camel-case</span>=<span class=\"hljs-string\">true</span>\n<span class=\"hljs-meta\">mybatis.configuration.use-generated-keys</span>=<span class=\"hljs-string\">true</span>\n\n<span class=\"hljs-meta\">logging.level.com.codingapi.txlcn</span>=<span class=\"hljs-string\">DEBUG</span>\n<span class=\"hljs-comment\">\n# 关闭Ribbon的重试机制（如果有必要）</span>\n<span class=\"hljs-meta\">ribbon.MaxAutoRetriesNextServer</span>=<span class=\"hljs-string\">0</span>\n<span class=\"hljs-meta\">ribbon.ReadTimeout</span>=<span class=\"hljs-string\">5000</span>\n<span class=\"hljs-meta\">ribbon.ConnectTimeout</span>=<span class=\"hljs-string\">5000</span>\n\n</code></pre>\n<ul>\n<li>启动类</li>\n</ul>\n<pre><code class=\"language-java\"><span class=\"hljs-meta\">@SpringBootApplication</span>\n<span class=\"hljs-meta\">@EnableDiscoveryClient</span>\n<span class=\"hljs-meta\">@EnableDistributedTransaction</span>\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SpringServiceAApplication</span> </span>{\n\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">(String[] args)</span> </span>{\n        SpringApplication.run(SpringServiceAApplication.class, args);\n    }\n}\n\n</code></pre>\n<ol start=\"2\">\n<li>事务参与方，txlcn-demo-spring-service-b</li>\n</ol>\n<ul>\n<li>工程截图<br>\n<img src=\"../../../img/docs/tc_project_b.png\" alt=\"maven project\"></li>\n<li>项目配置文件 application.properties</li>\n</ul>\n<pre><code class=\"language-properties\"><span class=\"hljs-comment\">##################</span>\n<span class=\"hljs-comment\"># 这个是启动本服务的配置文件，其它的application-xxx.properties 是开发者的个性化配置，不用关心。</span>\n<span class=\"hljs-comment\"># 你可以在 https://txlcn.org/zh-cn/docs/setting/client.html 看到所有的个性化配置</span>\n<span class=\"hljs-comment\">#################</span>\n\n<span class=\"hljs-meta\">spring.application.name</span>=<span class=\"hljs-string\">txlcn-demo-spring-service-b</span>\n<span class=\"hljs-meta\">server.port</span>=<span class=\"hljs-string\">12002</span>\n<span class=\"hljs-meta\">spring.datasource.type</span>=<span class=\"hljs-string\">com.alibaba.druid.pool.DruidDataSource</span>\n<span class=\"hljs-meta\">spring.datasource.driver-class-name</span>=<span class=\"hljs-string\">com.mysql.jdbc.Driver</span>\n<span class=\"hljs-comment\">## TODO 你的配置</span>\n<span class=\"hljs-meta\">spring.datasource.url</span>=<span class=\"hljs-string\">jdbc:mysql://127.0.0.1:3306/txlcn-demo\\\n  ?characterEncoding=UTF-8&amp;serverTimezone=UTC</span>\n<span class=\"hljs-meta\">spring.datasource.username</span>=<span class=\"hljs-string\">root</span>\n<span class=\"hljs-meta\">spring.datasource.password</span>=<span class=\"hljs-string\">root</span>\n<span class=\"hljs-comment\">#spring.datasource.hikari.maximum-pool-size=20</span>\n<span class=\"hljs-meta\">mybatis.configuration.map-underscore-to-camel-case</span>=<span class=\"hljs-string\">true</span>\n<span class=\"hljs-meta\">mybatis.configuration.use-generated-keys</span>=<span class=\"hljs-string\">true</span>\n\n<span class=\"hljs-meta\">logging.level.com.codingapi.txlcn</span>=<span class=\"hljs-string\">DEBUG</span>\n\n</code></pre>\n<ul>\n<li>启动类</li>\n</ul>\n<pre><code class=\"language-java\"><span class=\"hljs-meta\">@SpringBootApplication</span>\n<span class=\"hljs-meta\">@EnableDiscoveryClient</span>\n<span class=\"hljs-meta\">@EnableDistributedTransaction</span>\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SpringServiceBApplication</span> </span>{\n\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">(String[] args)</span> </span>{\n        SpringApplication.run(SpringServiceBApplication.class, args);\n    }\n}\n\n</code></pre>\n<ol start=\"3\">\n<li>事务参与方，txlcn-demo-spring-service-c</li>\n</ol>\n<ul>\n<li>工程截图<br>\n<img src=\"../../../img/docs/tc_project_c.png\" alt=\"maven project\"></li>\n<li>项目配置文件 application.properties</li>\n</ul>\n<pre><code class=\"language-properties\"><span class=\"hljs-comment\">##################</span>\n<span class=\"hljs-comment\"># 这个是启动本服务的配置文件，其它的application-xxx.properties 是开发者的个性化配置，不用关心。</span>\n<span class=\"hljs-comment\"># 你可以在 https://txlcn.org/zh-cn/docs/setting/client.html 看到所有的个性化配置</span>\n<span class=\"hljs-comment\">#################</span>\n\n<span class=\"hljs-meta\">spring.application.name</span>=<span class=\"hljs-string\">txlcn-demo-spring-service-c</span>\n<span class=\"hljs-meta\">server.port</span>=<span class=\"hljs-string\">12003</span>\n<span class=\"hljs-meta\">spring.datasource.driver-class-name</span>=<span class=\"hljs-string\">com.mysql.jdbc.Driver</span>\n<span class=\"hljs-comment\">\n## TODO 你的配置</span>\n<span class=\"hljs-meta\">spring.datasource.url</span>=<span class=\"hljs-string\">jdbc:mysql://127.0.0.1:3306/txlcn-demo\\\n  ?characterEncoding=UTF-8&amp;serverTimezone=UTC</span>\n<span class=\"hljs-meta\">spring.datasource.username</span>=<span class=\"hljs-string\">root</span>\n<span class=\"hljs-meta\">spring.datasource.password</span>=<span class=\"hljs-string\">root</span>\n<span class=\"hljs-meta\">spring.datasource.hikari.maximum-pool-size</span>=<span class=\"hljs-string\">20</span>\n<span class=\"hljs-meta\">mybatis.configuration.map-underscore-to-camel-case</span>=<span class=\"hljs-string\">true</span>\n<span class=\"hljs-meta\">mybatis.configuration.use-generated-keys</span>=<span class=\"hljs-string\">true</span>\n\n<span class=\"hljs-meta\">logging.level.com.codingapi.txlcn</span>=<span class=\"hljs-string\">DEBUG</span>\n\n</code></pre>\n<ul>\n<li>启动类</li>\n</ul>\n<pre><code class=\"language-java\"><span class=\"hljs-meta\">@SpringBootApplication</span>\n<span class=\"hljs-meta\">@EnableDiscoveryClient</span>\n<span class=\"hljs-meta\">@EnableDistributedTransaction</span>\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SpringServiceCApplication</span> </span>{\n\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">(String[] args)</span> </span>{\n        SpringApplication.run(SpringServiceCApplication.class, args);\n    }\n}\n\n</code></pre>\n<h2>三、启动SpringCloud微服务</h2>\n<p>事务参与方 ServiceB<br>\n<img src=\"../../../img/docs/tc_b.png\" alt=\"spring-b\">\n事务参与方 ServiceC<br>\n<img src=\"../../../img/docs/tc_c.png\" alt=\"spring-c\">\n事务发起方 ServiceA<br>\n<img src=\"../../../img/docs/tc_a.png\" alt=\"spring-a\"></p>\n",
  "link": "\\en-us\\docs\\demo\\springcloud.html",
  "meta": {}
}